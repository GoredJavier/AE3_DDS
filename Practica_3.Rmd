------------------------------------------------------------------------

title: "Practica_3" author: "F" date: "2025-01-21" output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r carga_librerias, include=FALSE}

library(readr)
library(stringr)
library(swirl)
library(RCurl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(RColorBrewer)

```

# Autores

**Práctica:** Actividad Evaluable 1\
**Asignatura:** Data Driven Security\
**Fecha:** `r format(Sys.time(), '%d-%m-%Y')`

| Grupo 1                   |
|:--------------------------|
| Javier Gómez Rodríguez    |
| Fernando Palma Villanueva |
| Mireia Náger Piazuelo     |

# 1. Data Science

## Pregunta 1

Una vez cargado el Dataset a analizar, comprobando que se cargan las IPs, el Timestamp, la Petición (Tipo, URL y Protocolo), Código de respuesta, y Bytes de reply.

1.  Cuales son las dimensiones del dataset cargado (número de filas y columnas)
2.  Valor medio de la columna Bytes

> Primero se carga el fichero epa_http.

```{r}

df <- read.csv2("https://raw.githubusercontent.com/GoredJavier/DataDrivenSecurity/refs/heads/main/epa-http.csv", sep=' ', header=FALSE)

colnames(df) <- c("Path","Date", "Request", "StatusCode", "Size")

df <- df %>%
  separate(Request, into = c("RequestType", "Resource", "Version"), sep = " ") %>%
  separate(Version, into = c("Protocol", "Version"), sep = "/") 

df$ResourceType <- str_extract(df$Resource, "\\.([a-zA-Z0-9]+)$") %>% 
      str_remove("^\\.")


#df$ResourceType <- mutate(
#    extension = str_extract(Resource, "\\.([a-zA-Z0-9]+)$") %>% 
#      str_remove("^\\.")
#  )

df$Date <- as.POSIXct(gsub("^\\[|\\]$", "", df$Date), format="%d:%H:%M:%S")

df$RequestType <- as.factor(df$RequestType)
df$Protocol <- as.factor(df$Protocol)
df$Version <- as.factor (df$Version)
df$StatusCode <- as.factor(df$StatusCode)
df$Size <- as.numeric(df$Size)
df$Version <- as.factor(df$Version)
df$ResourceType <- as.factor (df$ResourceType)

df <- df %>%
  select(
    1:4,                # Las primeras 4 columnas permanecen igual
    ResourceType,       # Mover la columna específica a la posición 5
    5:ncol(df)          # Las demás columnas (a partir de la 5) se desplazan hacia la derecha
  )

```

```{r Numero unico de usuarios}

#Respuestas informativas (100–199),
#Respuestas satisfactorias (200–299),
#Redirecciones (300–399),
#Errores de los clientes (400–499),
#y errores de los servidores (500–599).

#4. Se pide: Identificar el número único de usuarios que han interactuado
# directamente con el servidor de forma segregada según si los usuarios
# han tenido algún tipo de error en las distintas peticiones ofrecidas por el
# servidor.

# Clasificar usuarios
resumen_usuarios <- df %>%
  group_by(Path) %>%
  reframe(
    StatusCode = unique(as.numeric(as.character(StatusCode))[as.numeric(as.character(StatusCode)) >= 400])
  ) 

resultado_final <- resumen_usuarios %>%
  group_by(StatusCode) %>%
  reframe(
    num_usuarios = n())

```

```{r Pregunta 5}

#Analizar los distintos tipos de peticiones HTTP (GET, POST, PUT, DELETE) gestionadas por el servidor, identificando la frecuencia de cada una de estas.

# Obtener la tabla de frecuencias de la columna 'status_code'
tabla_frecuencias <- table(df$RequestType)

# Mostrar la tabla de frecuencias
print(tabla_frecuencias)

#Repetir el análisis, esta vez filtrando previamente aquellas peticiones correspondientes a recursos ofrecidos de tipo imagen.
df_imagenes <- df %>%
  filter(ResourceType %in% c("jpg", "jpeg", "png", "gif", "bmp", "svg"))

tabla_imagenes <- table(df_imagenes$RequestType)

print(tabla_imagenes)

```

```{r Pie chart frecuencia protocolos}

#Añadir colores si podemos

#Pregunta 6: Generar al menos 2 gráficos distintos que permitan visualizar alguna característica relevante de los datos analizados.Estos deberán representar por lo menos 1 o 2 variables diferentes del data frame. Describid el gráfico e indicad cualquier observación destacable que se pueda apreciar gracias a la representación gráfica.

df_protocols <- as.data.frame(tabla_frecuencias)
colnames(df_protocols) <- c("RequestType","Value")
df_protocols$Porcentaje <- round(df_protocols$Value/length(df$StatusCode)*100,1)

paleta <- colorRampPalette(brewer.pal(6, "YlGnBu"))

# Crear el gráfico de pastel
ggplot(df_protocols, aes(x = "", y = Porcentaje, fill = RequestType)) +
  geom_bar(stat = "identity", width = 0.9) +  # Crea las barras
  coord_polar(theta = "y") +  # Convierte las barras en un gráfico circular
  labs(title = "Porcentaje según tipo de request") +
  theme_void() + # Elimina los ejes y fondo para que sea solo un pastel
  geom_text_repel(aes(label=paste0(Porcentaje,"%")), position = position_stack(vjust = 0.5)) + 
  scale_fill_manual(values=paleta(length(df_protocols$Porcentaje)))

#Falta un gráfico!!


```



```{r #7_Request Vs Time - Histograma}

# 7. Generar un gráfico que permita visualizar el número de peticiones servidas a lo largo del tiempo.


table_TimeVsRequest <- table(df$Date, df$RequestType)
df_TimeVsRequest <- as.data.frame(table_TimeVsRequest)
colnames(df_TimeVsRequest) <- c("Time", "RequestType", "Request")
df_TimeVsRequest$Time <- as.POSIXct(df_TimeVsRequest$Time, format="%Y-%m-%d %H:%M:%S") # Se convierte la columna time en formato de fecha y hora

# Crear la gráfica
ggplot(df_TimeVsRequest, aes(x = Time)) +
  geom_histogram(binwidth = 3600, fill = "coral", color = "black") +
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%Y-%m-%d %H:%M") +
  labs(title = "Histograma de Fechas por Hora",
       x = "Fecha y Hora",
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
geom_text(stat = "bin", aes(label = ..count..), binwidth = 3600, hjust= -0.2 , angle = 90)


```




```{r PRUEBAS, include=FALSE}


#df_TimeVsRequest$Request <- as.numeric(df_TimeVsRequest$Request)

#scale_x_discrete(breaks = unique(df_TimeVsRequest$Time)[seq(1, nrow(unique(df_TimeVsRequest)), by = 500)]) + # Mostrar 1 de cada 10 fechas
  

#scale_x_discrete(breaks = df_TimeVsRequest$Time[df_TimeVsRequest$Request > 10]) +   

#df_TimeVsRequest$Time[df_TimeVsRequest$Request > 5]


#df_TimeVsRequest$Time1 <- as.POSIXct(df_TimeVsRequest$Time, format="%Y-%m-%d %H:%M:%S")

#geom_bar(stat = "identity", position = "stack") +



  
  
```

